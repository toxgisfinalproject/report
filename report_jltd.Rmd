---
title: "Report"
author: "James Dalgleish, Joy Hsu, Rachel Tsong, Yishan Wang, Adina Zhang"
date: "6 December 2018"
output: html_document
---

```{r}
library(magrittr)
library(tidyverse)
library(tigris)
library(sf)
library(furrr)
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
```

## Motivation
It is well known that exposure to chemicals released by industry can be a causal factor for many cancers. For this project, we wanted to know if we could use datasets that are publicly available to see if there is a geographic association between 

## Related Work

## Initial Questions

## Data
```{r data_import}
# if ( !file.exists("county_cancer_chem_pop.rds") ) {
#   download.file("https://www.dropbox.com/s/medxedvfc37ojs7/cancer_county_chem_pop.rds?dl=1","cancer_county_chem_pop.rds")
# }
# download.file("https://drive.google.com/uc?export=download&confirm=DHoB&id=1ug9DSsEQWo8B5yfdFhy8GPXpFM0xUBfv","county_cancer_chem_pop.csv")
# download.file("https://github.com/toxgisfinalproject/joint_anal/raw/master/cancer_county_chem_pop.rds","cancer_county_chem_pop.rds")
#https://drive.google.com/uc?id=1ug9DSsEQWo8B5yfdFhy8GPXpFM0xUBfv&export=download
county_cancer_chem = readRDS( "cancer_county_chem_pop.rds") %>% 
      mutate(incidence = n/pop_est)
# county_cancer_chem = read_csv( "county_cancer_chem_pop.csv") %>% 
#       mutate(incidence = n/pop_est)
#library(rdrop2)
```

## Exploratory Analysis

###Chloropleths

Here, we'll see the geographic distribution of Benzene in a single year and the trend across time (incidence slope).
```{r }
#a single year function
state_chem_map <- function(spec_state,spec_chem, spec_year,print = TRUE)
{
      if( !exists("county_cancer_chem") ) {
        county_cancer_chem = readRDS( "cancer_county_chem_pop.rds") %>% 
      mutate(incidence = n/pop_est)
      }
      options(tigris_class = "sf")
      state_sf <- tigris::counties(state = spec_state) %>%
      janitor::clean_names() %>%
      dplyr::mutate(name = tolower(name))
      state_chem <- county_cancer_chem %>%
      dplyr::filter(chemical == spec_chem &
      st == spec_state, year == spec_year) %>%
      select(total_rel_summ,county,year) %>%
      ungroup() %>%
      distinct() %>%
      right_join(state_sf, by = c("county" = "name")) %>%
      mutate(log_total_rel = 
      log(total_rel_summ + 0.001))
      ggp <- ggplot() +
      geom_sf(data = state_chem, aes(fill=log((total_rel_summ + 0.001)/aland),group=county)) +
      scale_fill_viridis_c(option = "magma",
      guide = guide_legend(
        direction = "horizontal",
        title.position = "top",
        label.position = "bottom",
        label.hjust = 0.5,
        label.vjust = 1,
        label.theme = element_text(angle = 90)
      )) +
      labs(fill = stringr::str_c(spec_state, " ", spec_chem, " releases by county, divided by land area ", "in ", spec_year) ) +
      theme(legend.position = "bottom")

      return(ggp)
}

state_chem_map(spec_state = "ca", spec_chem = "BENZENE", spec_year = "2009", print = T)
```
```{r}
library(patchwork)
library(furrr)
#does not work
#doParallel::registerDoParallel()
plan(multiprocess)
ggplist_benzene <- 1987:2009 %>%
  furrr::future_map(.x = ., .f = state_chem_map,spec_state = "ca", spec_chem = "BENZENE", print = F)
patchwork::wrap_plots(ggplist_benzene)
state_chem_map(spec_state = "ca", spec_chem = "BENZENE", spec_year = "2009", print = T)
```
```{r function_facet_across_years}
state_chem_map_all_years <- function(spec_state,spec_chem, spec_year,print = TRUE)
{
      if( !exists("county_cancer_chem") ) {
        county_cancer_chem = readRDS( "cancer_county_chem_pop.rds") %>% 
      mutate(incidence = n/pop_est)
      }
      options(tigris_class = "sf")
      state_sf <- tigris::counties(state = spec_state) %>%
      janitor::clean_names() %>%
      dplyr::mutate(name = tolower(name)) %>% 
        select(-metdivfp,-csafp,-cbsafp)
      state_chem <- county_cancer_chem %>%
      dplyr::filter(chemical == spec_chem &
      st == spec_state) %>%
      select(total_rel_summ,county,year) %>%
      ungroup() %>%
      distinct() %>%
      right_join(state_sf, by = c("county" = "name")) %>%
      mutate(log_total_rel = 
      log(total_rel_summ + 0.001)
      ) %>% 
       replace_na(list(total_rel_summ = 0, log_total_rel = 0,
                       metdivp = "", csafp = "", cbasafp = "",
                       st = spec_state, chemical = spec_chem))
      #  drop_na()
      ggp <- ggplot() +
      geom_sf(data = state_chem, aes(fill = total_rel_summ/aland,group=county, facet = year)) +
      scale_fill_viridis_c(option = "magma") +
      labs(fill = stringr::str_c(spec_state, " ", spec_chem, " releases by county, log transformed, divided by land area,", " across all years") ) +
      theme(legend.position = "bottom") + facet_wrap(~year)

      return(ggp)
}
#log((total_rel_summ + 0.001)
#do not use!
#state_chem_map_all_years(spec_state = "ca", spec_chem = "BENZENE", print = T)
```

```{r state_slope}
cancer_slope_plot <- function(spec_state, spec_cancer, print = TRUE)
{    
      if( !exists("county_cancer_chem") ) {
      county_cancer_chem = readRDS( "cancer_county_chem_pop.rds") %>% 
      mutate(incidence = n/pop_est) }
      options(tigris_class = "sf")
      state_sf <- tigris::counties(state = spec_state) %>%
      janitor::clean_names() %>%
      dplyr::mutate(name = tolower(name)) %>% 
      select(-metdivfp,-csafp,-cbsafp)
      cancer_state_subset <- county_cancer_chem %>% 
      filter(cancer == spec_cancer & st == spec_state) %>% 
      select(prevalence,year,cancer) %>% 
      spread(year,prevalence) %>% 
      ungroup() %>% 
      select(-chemical,-st,-cancer) %>% 
      distinct() %>% 
      replace_na(list(prevalence = 0)) %>% 
      as.data.frame()
      cancer_sf_joined <- state_sf %>%
      left_join(cancer_state_subset, by = c("name" = "county"))
      first_year <- intersect(1987:2009,
      names(cancer_sf_joined)) %>% 
      min()
      last_year <- intersect(1987:2009,
      names(cancer_sf_joined)) %>% 
      max()
      cancer_sf_gathered <- cancer_sf_joined %>%
      gather(key=year,value=prevalence,first_year:last_year)
      cancer_lm <- cancer_sf_gathered %>%
      replace_na(list(prevalence = 0)) %>%
      mutate(year = as.numeric(year)) %>%
      group_by(name) %>%
      mutate(prev_kurt = e1071::kurtosis(prevalence)) %>%
      nest() %>%
      mutate(county_prev_lm = map(data, ~lm(formula = prevalence ~ year, data = .x)) ) %>%
      mutate(lm_tidy = map(county_prev_lm, broom::tidy, conf.int = TRUE)) %>%
      select(-data, -county_prev_lm) %>%
      unnest() %>%
      filter(term == "year")
      cancer_sf_joined_lm <- cancer_sf_joined %>% 
      right_join(cancer_lm, by = "name")
      slope_plot <- ggplot(data = cancer_sf_joined_lm,
      aes(fill=estimate*1e5,group=name)) +
      geom_sf() +
      scale_fill_viridis_c(option = "magma",
      guide = guide_legend(
        direction = "horizontal",
        title.position = "top",
        label.position = "bottom",
        label.hjust = 0.5,
        label.vjust = 1,
        label.theme = element_text(angle = 90)
      )) +
      labs(fill = str_c("slope of ", spec_cancer, " cancer prevalence in ", toupper(spec_state), ", per 100,000 persons")) +
      theme(legend.position = "bottom")
      if (print) {
        print(slope_plot)
      }
      return(slope_plot)
}
cancer_slope_plot(spec_state = "ca", spec_cancer = "AML", print = T)
```
```{r all_state_slope_aml, fig.height = 20, fig.width = 20, fig.align = "center"}
all_states <- county_cancer_chem %>% 
  pull(st) %>% 
  unique()
ggplist_aml <- all_states %>% 
  map(.x = ., .f = cancer_slope_plot, spec_cancer = "AML", print = F)
# par(mfrow=c(2,5)) #faceting is broken for geom_sf (part of tidyverse). 
# ggplist_aml
# patchwork::wrap
library(patchwork)
#ggplist_aml[[1]] + ggplist_aml[[2]] + ggplist_aml[[3]] + ggplist_aml[[4]] 
#map(ggplist_aml, `+`) + plot_layout(ncol = 4)
patchwork::wrap_plots(ggplist_aml) + plot_layout(ncol = 4)
```

## Additional Analysis

## Discussion




















